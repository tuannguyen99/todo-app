# Story 1.2: Todo Data Model & Local Storage Utility

## Status

Draft

## Story

**As a** developer,
**I want** a type-safe todo data model and local storage utility,
**so that** I can reliably persist and retrieve todo data with proper error handling.

## Acceptance Criteria

1. TypeScript interface defined for Todo: `{ id: string, text: string, completed: boolean, createdAt: number }`
2. Local storage utility module created with functions: `saveTodos()`, `loadTodos()`, `clearTodos()`
3. Utility handles JSON serialization/deserialization with proper error handling
4. Utility gracefully handles cases where localStorage is unavailable or disabled
5. Storage key is configurable (default: `'todos'`)
6. Unit tests verify all utility functions work correctly including error cases
7. TypeScript types ensure type safety for all storage operations

## Tasks / Subtasks

- [ ] Create Todo TypeScript interface (AC: 1, 7)
  - [ ] Create file `types/todo.ts`
  - [ ] Define core `Todo` interface with id, text, completed, createdAt
  - [ ] Define `CreateTodoInput` type (Pick<Todo, 'text'>)
  - [ ] Define `UpdateTodoInput` type (Partial<Pick<Todo, 'text' | 'completed'>>)
  - [ ] Add JSDoc comments for all types
  - [ ] Export all types

- [ ] Create validation utilities (AC: 7)
  - [ ] Create file `lib/utils/validation.ts`
  - [ ] Implement `isValidTodoText()` function (checks trim().length > 0 and <= 500)
  - [ ] Define `TODO_CONSTRAINTS` constant object with MIN_TEXT_LENGTH, MAX_TEXT_LENGTH, STORAGE_KEY
  - [ ] Export validation function and constants
  - [ ] Add JSDoc comments

- [ ] Create local storage utility module (AC: 2, 3, 4, 5)
  - [ ] Create file `lib/services/todoStorage.ts`
  - [ ] Define `StorageError` class extending Error with code property
  - [ ] Define error codes: 'UNAVAILABLE', 'QUOTA_EXCEEDED', 'SAVE_ERROR', 'LOAD_ERROR'
  - [ ] Define `ERROR_MESSAGES` constant mapping codes to user-friendly messages
  - [ ] Implement `saveTodos(todos: Todo[], key?: string)` function
    - [ ] Wrap in try-catch block
    - [ ] Serialize todos array to JSON
    - [ ] Save to localStorage with key (default from TODO_CONSTRAINTS.STORAGE_KEY)
    - [ ] Catch QuotaExceededError and throw StorageError with QUOTA_EXCEEDED code
    - [ ] Catch other errors and throw StorageError with SAVE_ERROR code
  - [ ] Implement `loadTodos(key?: string): Todo[]` function
    - [ ] Wrap in try-catch block
    - [ ] Retrieve from localStorage with key
    - [ ] Return empty array if no data found
    - [ ] Parse JSON and validate structure
    - [ ] Return parsed todos array
    - [ ] Catch JSON parse errors and return empty array
    - [ ] Catch other errors and throw StorageError with LOAD_ERROR code
  - [ ] Implement `clearTodos(key?: string)` function
    - [ ] Remove key from localStorage
    - [ ] Handle errors gracefully
  - [ ] Implement `isStorageAvailable()` helper function
    - [ ] Test localStorage availability
    - [ ] Return boolean
  - [ ] Export all functions and error types
  - [ ] Add JSDoc comments for all functions

- [ ] Write unit tests for validation utilities (AC: 6)
  - [ ] Create file `__tests__/lib/utils/validation.test.ts`
  - [ ] Test `isValidTodoText()` with valid text
  - [ ] Test `isValidTodoText()` with empty string (should return false)
  - [ ] Test `isValidTodoText()` with whitespace-only string (should return false)
  - [ ] Test `isValidTodoText()` with 500 character text (should return true)
  - [ ] Test `isValidTodoText()` with 501 character text (should return false)
  - [ ] Verify TODO_CONSTRAINTS values are correct

- [ ] Write unit tests for todoStorage service (AC: 6)
  - [ ] Create file `__tests__/lib/services/todoStorage.test.ts`
  - [ ] Mock localStorage in beforeEach/afterEach
  - [ ] Test `saveTodos()` successfully saves valid todo array
  - [ ] Test `saveTodos()` throws StorageError on quota exceeded
  - [ ] Test `saveTodos()` throws StorageError when localStorage unavailable
  - [ ] Test `loadTodos()` successfully loads saved todos
  - [ ] Test `loadTodos()` returns empty array when no data exists
  - [ ] Test `loadTodos()` returns empty array on invalid JSON
  - [ ] Test `loadTodos()` returns empty array when localStorage unavailable
  - [ ] Test `clearTodos()` removes data from localStorage
  - [ ] Test custom storage key parameter works for all functions
  - [ ] Test `isStorageAvailable()` returns true when localStorage works
  - [ ] Test `isStorageAvailable()` returns false when localStorage unavailable
  - [ ] Verify all error codes and messages are correct

- [ ] Verify type safety and exports (AC: 7)
  - [ ] Run `npm run type-check` and verify no TypeScript errors
  - [ ] Verify all types are exported from `types/todo.ts`
  - [ ] Verify all utilities are exported from their modules
  - [ ] Verify imports work with `@/` path alias

- [ ] Run all tests and verify coverage (AC: 6)
  - [ ] Run `npm test` and verify all tests pass
  - [ ] Run `npm run test:coverage` and verify >80% coverage for new files
  - [ ] Fix any failing tests

## Dev Notes

### Previous Story Insights
[Source: Story 1.1 Dev Agent Record]

Story 1.1 established the project foundation with Next.js 14, TypeScript strict mode, Tailwind CSS, Jest, and the required folder structure. All configuration files are in place, and the testing infrastructure is ready for use.

**Key Points:**
- TypeScript strict mode is enabled in `tsconfig.json`
- Path alias `@/` is configured for absolute imports
- Jest is configured with Next.js preset and jsdom environment
- `__tests__/setup.ts` imports `@testing-library/jest-dom`
- Folder structure includes: `types/`, `lib/services/`, `lib/utils/`, `__tests__/lib/services/`, `__tests__/lib/utils/`

### Data Models (DEFINITIVE)
[Source: architecture/data-models.md]

**Todo Interface:**
```typescript
/**
 * Represents a single todo item in the application.
 * This is the core data model used throughout the app.
 */
export interface Todo {
  /** Unique identifier (UUID v4) */
  id: string;
  
  /** User-entered todo text content */
  text: string;
  
  /** Whether the todo is marked as complete */
  completed: boolean;
  
  /** Creation timestamp in milliseconds since Unix epoch */
  createdAt: number;
}
```

**Helper Types:**
```typescript
/**
 * Type for creating a new todo (omits id and createdAt which are auto-generated)
 */
export type CreateTodoInput = Pick<Todo, 'text'>;

/**
 * Type for updating a todo (allows partial updates)
 */
export type UpdateTodoInput = Partial<Pick<Todo, 'text' | 'completed'>>;
```

**Validation Rules:**
```typescript
/**
 * Validates todo text input
 */
export const isValidTodoText = (text: string): boolean => {
  return text.trim().length > 0 && text.trim().length <= 500;
};

/**
 * Constants for todo validation
 */
export const TODO_CONSTRAINTS = {
  MIN_TEXT_LENGTH: 1,
  MAX_TEXT_LENGTH: 500,
  STORAGE_KEY: 'todos'
} as const;
```

**Design Decisions:**
- UUID as string using native `crypto.randomUUID()` (no dependencies)
- Unix timestamp as number for efficient sorting
- Boolean completion (simple true/false)
- No updatedAt field (not required by PRD)
- Storage format: JSON array in localStorage under key `'todos'`

### Storage Architecture
[Source: architecture/data-models.md]

**Storage Format:**
- Todos stored as JSON array in localStorage
- Default storage key: `'todos'`
- Key is configurable for testing/flexibility

**Error Handling:**
[Source: architecture/error-handling-strategy.md]

```typescript
// Standardized error type
export class StorageError extends Error {
  constructor(
    message: string,
    public code: 'UNAVAILABLE' | 'QUOTA_EXCEEDED' | 'SAVE_ERROR' | 'LOAD_ERROR'
  ) {
    super(message);
    this.name = 'StorageError';
  }
}

// User-friendly error messages
export const ERROR_MESSAGES = {
  UNAVAILABLE: 'Storage is not available. Your todos will not be saved.',
  QUOTA_EXCEEDED: 'Storage limit reached. Please delete some todos to free up space.',
  SAVE_ERROR: 'Failed to save your changes. Please try again.',
  LOAD_ERROR: 'Failed to load your todos. Please refresh the page.'
} as const;
```

### File Locations (REQUIRED)
[Source: architecture/unified-project-structure.md]

Create files in these exact locations:
- `types/todo.ts` - Todo interface and helper types
- `lib/utils/validation.ts` - Validation utilities
- `lib/services/todoStorage.ts` - localStorage wrapper service
- `__tests__/lib/utils/validation.test.ts` - Validation tests
- `__tests__/lib/services/todoStorage.test.ts` - Storage service tests

### TypeScript Requirements
[Source: architecture/coding-standards.md, architecture/tech-stack.md]

**Critical Rules:**
- NEVER use `any` type without explicit justification
- All functions must have explicit return types
- Use absolute imports with `@/` prefix (e.g., `import { Todo } from '@/types/todo'`)
- All exports must be named exports (no default exports)
- Add JSDoc comments for all public interfaces, types, and functions

**Naming Conventions:**
- Types/Interfaces: PascalCase (e.g., `Todo`, `CreateTodoInput`)
- Functions: camelCase (e.g., `isValidTodoText`, `saveTodos`)
- Constants: UPPER_SNAKE_CASE (e.g., `TODO_CONSTRAINTS`, `ERROR_MESSAGES`)

### Testing Requirements
[Source: architecture/testing-strategy.md]

**Test Organization:**
- Unit tests for validation: `__tests__/lib/utils/validation.test.ts`
- Unit tests for storage: `__tests__/lib/services/todoStorage.test.ts`

**Test Coverage Target:** 80%+ for utility and service code

**Storage Service Test Requirements:**
- Mock localStorage using Jest's `beforeEach`/`afterEach` hooks
- Test successful save/load operations
- Test error scenarios: quota exceeded, localStorage unavailable, invalid JSON
- Test custom storage key parameter
- Verify all StorageError codes are thrown correctly

**Validation Test Requirements:**
- Test valid text (trimmed, 1-500 characters)
- Test invalid text: empty, whitespace-only, >500 characters
- Test boundary conditions (exactly 500 characters)

**Example Test Structure:**
```typescript
describe('todoStorage', () => {
  beforeEach(() => {
    localStorage.clear();
  });

  describe('saveTodos', () => {
    it('should save todos to localStorage', () => {
      const mockTodos: Todo[] = [
        { id: '1', text: 'Test', completed: false, createdAt: Date.now() }
      ];
      
      todoStorage.saveTodos(mockTodos);
      
      const stored = localStorage.getItem('todos');
      expect(stored).not.toBeNull();
      expect(JSON.parse(stored!)).toEqual(mockTodos);
    });

    it('should throw StorageError when quota exceeded', () => {
      const setItemSpy = jest.spyOn(Storage.prototype, 'setItem');
      const quotaError = new DOMException('Quota exceeded', 'QuotaExceededError');
      setItemSpy.mockImplementation(() => { throw quotaError; });

      expect(() => todoStorage.saveTodos([]))
        .toThrow(StorageError);

      setItemSpy.mockRestore();
    });
  });
});
```

### ID Generation
[Source: architecture/tech-stack.md]

Use native browser API for UUID generation:
```typescript
const newTodo: Todo = {
  id: crypto.randomUUID(), // Browser-native, no dependencies
  text: 'Example',
  completed: false,
  createdAt: Date.now()
};
```

**Note:** ID generation will be used in later stories (Story 1.3+), but the Todo interface defined in this story must support it.

### Success Criteria Verification

Before marking this story as complete, verify:

1. ✅ `types/todo.ts` exists with Todo interface and helper types
2. ✅ `lib/utils/validation.ts` exists with validation function and constants
3. ✅ `lib/services/todoStorage.ts` exists with saveTodos, loadTodos, clearTodos functions
4. ✅ StorageError class defined with all error codes
5. ✅ All functions have proper error handling with try-catch blocks
6. ✅ `__tests__/lib/utils/validation.test.ts` exists with comprehensive tests
7. ✅ `__tests__/lib/services/todoStorage.test.ts` exists with comprehensive tests
8. ✅ `npm run type-check` passes with no errors
9. ✅ `npm test` passes with all tests green
10. ✅ `npm run test:coverage` shows >80% coverage for new files
11. ✅ All exports use named exports (no default exports)
12. ✅ All imports use `@/` path alias
13. ✅ JSDoc comments added for all public interfaces and functions

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-29 | 1.0 | Story created from Epic 1 | Bob (SM) |

## Dev Agent Record

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes List

_To be filled by dev agent during implementation_

### File List

_To be filled by dev agent with all files created/modified_

## QA Results

_To be filled by QA agent after implementation review_
