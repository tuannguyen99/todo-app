# Story 1.5: Toggle Todo Completion

## Status

Draft

## Story

**As a** user,
**I want** to mark todos as complete or incomplete by clicking a checkbox,
**so that** I can track my progress on tasks.

## Acceptance Criteria

1. Each todo has a checkbox that reflects its completion status
2. Clicking checkbox toggles the completed state
3. Completed todos show visual feedback (strikethrough text, muted color)
4. Incomplete todos return to normal appearance when unchecked
5. Completion state change is persisted to local storage immediately
6. Checkbox is keyboard accessible (Space/Enter keys toggle state)
7. Component tests verify toggle functionality and visual state changes

## Tasks / Subtasks

- [ ] Verify TodoItem checkbox functionality (AC: 1, 2, 3, 4)
  - [ ] Open file `components/TodoItem.tsx`
  - [ ] Verify checkbox is already implemented with:
    - [ ] `type="checkbox"`
    - [ ] `checked={todo.completed}` attribute
    - [ ] `onChange={() => onToggle()}` handler
    - [ ] Proper Tailwind styling for checkbox appearance
    - [ ] ARIA label with todo text context
  - [ ] Verify visual feedback for completed state:
    - [ ] Strikethrough class applied: `line-through`
    - [ ] Muted color applied: `text-gray-500`
    - [ ] Normal text color for incomplete: `text-gray-900`
  - [ ] Test checkbox manually in browser
    - [ ] Click checkbox on incomplete todo
    - [ ] Verify strikethrough and color change appear
    - [ ] Click checkbox on completed todo
    - [ ] Verify strikethrough and color change disappear

- [ ] Verify useTodos hook toggleTodo function (AC: 2, 5)
  - [ ] Open file `lib/hooks/useTodos.ts`
  - [ ] Confirm `toggleTodo` function exists and is exported
  - [ ] Review implementation:
    - [ ] Finds todo by id
    - [ ] Calls `updateTodo` with `{ completed: !todo.completed }`
    - [ ] State updates optimistically
    - [ ] Saves to localStorage via todoStorage
    - [ ] Handles errors with rollback
  - [ ] Verify function is passed to TodoList in TodoApp

- [ ] Verify TodoApp integration (AC: 2, 5)
  - [ ] Open file `components/TodoApp.tsx`
  - [ ] Confirm `toggleTodo` is destructured from useTodos hook
  - [ ] Verify `onToggleTodo={toggleTodo}` is passed to TodoList
  - [ ] Confirm TodoList passes it correctly to TodoItem

- [ ] Enhance checkbox keyboard accessibility (AC: 6)
  - [ ] Open file `components/TodoItem.tsx`
  - [ ] Verify checkbox is keyboard accessible by default (native HTML behavior)
  - [ ] Test keyboard interaction manually:
    - [ ] Tab to checkbox
    - [ ] Press Space key to toggle
    - [ ] Verify state changes
    - [ ] Verify visual feedback appears
  - [ ] If needed, add explicit keyboard handler for better UX:
    ```typescript
    onKeyDown={(e) => {
      if (e.key === ' ' || e.key === 'Enter') {
        e.preventDefault();
        onToggle();
      }
    }}
    ```
  - [ ] Ensure focus indicator is visible (Tailwind: `focus:ring-2 focus:ring-blue-500`)

- [ ] Write comprehensive tests for toggle functionality (AC: 7)
  - [ ] Open file `__tests__/components/TodoItem.test.tsx`
  - [ ] Add or verify test: "should call onToggle when checkbox is clicked"
    - [ ] Render TodoItem with incomplete todo
    - [ ] Get checkbox by role
    - [ ] Fire click event
    - [ ] Verify onToggle callback was called
  - [ ] Add or verify test: "should apply strikethrough and muted color when completed"
    - [ ] Render TodoItem with completed todo
    - [ ] Get text span element
    - [ ] Assert `line-through` class is present
    - [ ] Assert `text-gray-500` class is present
  - [ ] Add or verify test: "should not have strikethrough when incomplete"
    - [ ] Render TodoItem with incomplete todo
    - [ ] Get text span element
    - [ ] Assert `line-through` class is NOT present
    - [ ] Assert `text-gray-900` class is present
  - [ ] Add or verify test: "should toggle on Space key press"
    - [ ] Render TodoItem
    - [ ] Get checkbox
    - [ ] Fire keyDown event with Space key
    - [ ] Verify onToggle was called
  - [ ] Add or verify test: "should have descriptive ARIA label"
    - [ ] Render TodoItem with incomplete todo
    - [ ] Get checkbox by ARIA label
    - [ ] Verify label includes todo text and completion state

- [ ] Write integration tests for TodoApp toggle flow (AC: 2, 5)
  - [ ] Open file `__tests__/components/TodoApp.test.tsx`
  - [ ] Add test: "should toggle todo completion status"
    - [ ] Mock useTodos hook with toggleTodo function
    - [ ] Render TodoApp with one incomplete todo
    - [ ] Find and click checkbox
    - [ ] Verify toggleTodo was called with correct todo id
  - [ ] Add test: "should persist toggle to localStorage"
    - [ ] Use real useTodos hook (no mock)
    - [ ] Render TodoApp
    - [ ] Add a todo
    - [ ] Toggle the todo's checkbox
    - [ ] Verify localStorage was updated with completed: true
    - [ ] Toggle again
    - [ ] Verify localStorage was updated with completed: false

- [ ] Write tests for useTodos hook toggle functionality (AC: 2, 5)
  - [ ] Open file `__tests__/lib/hooks/useTodos.test.ts`
  - [ ] Add or verify test: "should toggle todo completion"
    - [ ] Render hook
    - [ ] Add a todo
    - [ ] Get todo id
    - [ ] Call toggleTodo(id)
    - [ ] Verify todo.completed changed from false to true
    - [ ] Call toggleTodo(id) again
    - [ ] Verify todo.completed changed from true to false
  - [ ] Add test: "should save to localStorage when toggling"
    - [ ] Render hook
    - [ ] Add a todo
    - [ ] Toggle todo
    - [ ] Verify todoStorage.saveTodos was called with updated todos
  - [ ] Add test: "should handle toggle error gracefully"
    - [ ] Mock todoStorage.saveTodos to throw error
    - [ ] Render hook
    - [ ] Add a todo
    - [ ] Toggle todo
    - [ ] Verify error state is set
    - [ ] Verify todo state was rolled back

- [ ] Manual testing and verification (AC: 1-7)
  - [ ] Run `npm run dev` and open browser to localhost:3000
  - [ ] Add several todos if none exist
  - [ ] Test clicking checkbox on incomplete todo:
    - [ ] Verify checkbox becomes checked
    - [ ] Verify text shows strikethrough
    - [ ] Verify text color becomes muted (gray)
    - [ ] Verify change happens immediately (<100ms)
  - [ ] Test clicking checkbox on completed todo:
    - [ ] Verify checkbox becomes unchecked
    - [ ] Verify strikethrough disappears
    - [ ] Verify text color returns to normal (dark)
  - [ ] Test rapid toggling (click multiple times quickly):
    - [ ] Verify each toggle is registered
    - [ ] Verify UI stays in sync
  - [ ] Test keyboard accessibility:
    - [ ] Tab to a checkbox
    - [ ] Verify focus indicator is visible
    - [ ] Press Space key
    - [ ] Verify todo toggles
    - [ ] Press Space again
    - [ ] Verify todo toggles back
  - [ ] Test persistence:
    - [ ] Toggle a todo to completed
    - [ ] Refresh the page
    - [ ] Verify todo is still completed (checkbox checked, strikethrough visible)
    - [ ] Toggle back to incomplete
    - [ ] Refresh the page
    - [ ] Verify todo is incomplete
  - [ ] Test with multiple todos:
    - [ ] Toggle different todos to completed
    - [ ] Verify each todo's state is independent
    - [ ] Verify completed todos maintain strikethrough
    - [ ] Verify incomplete todos have normal appearance

- [ ] Run all tests and verify passing (AC: 7)
  - [ ] Run `npm test` and verify all tests pass
  - [ ] Run `npm run test:coverage` and verify coverage remains >80%
  - [ ] Fix any failing tests

- [ ] Run type checking and linting
  - [ ] Run `npm run type-check` and verify no TypeScript errors
  - [ ] Run `npm run lint` and fix any linting errors

## Dev Notes

### Previous Story Context

**Story 1.4 Context:**
[Source: Story 1.4 Implementation - Expected to be Complete]

Story 1.4 implemented the display functionality with TodoList and TodoItem components. The TodoItem component **already includes the checkbox with toggle functionality** - this story is primarily about **verification and testing** rather than new implementation.

**What Already Exists (from Story 1.4):**
- ✅ TodoItem component with checkbox
- ✅ Checkbox reflects completion status (`checked={todo.completed}`)
- ✅ Checkbox calls `onToggle` callback when clicked
- ✅ Visual styling for completed state (strikethrough, muted color)
- ✅ useTodos hook with `toggleTodo` function fully implemented
- ✅ TodoApp passes `toggleTodo` to TodoList via `onToggleTodo` prop
- ✅ TodoList passes toggle handler to each TodoItem

**What This Story Adds:**
1. Comprehensive testing of toggle functionality
2. Verification that keyboard accessibility works correctly
3. Integration tests for complete toggle flow
4. Manual testing to ensure smooth user experience
5. Performance verification (<100ms visual feedback per NFR3)

### TodoItem Checkbox Implementation
[Source: architecture/components.md, Story 1.4]

**Current Implementation (Story 1.4):**

```typescript
// components/TodoItem.tsx - Display Mode (checkbox section)
<input
  type="checkbox"
  checked={todo.completed}
  onChange={onToggle}
  className="w-5 h-5 rounded border-gray-300 text-blue-500 focus:ring-2 focus:ring-blue-500"
  aria-label={`Mark "${todo.text}" as ${todo.completed ? 'incomplete' : 'complete'}`}
/>
```

**Visual Feedback Implementation:**

```typescript
// Text span with conditional classes
<span
  className={`flex-1 ${
    todo.completed
      ? 'line-through text-gray-500'
      : 'text-gray-900'
  }`}
>
  {todo.text}
</span>
```

**Key Points:**
- Native HTML checkbox provides built-in keyboard support (Space/Enter)
- Tailwind `focus:ring-2 focus:ring-blue-500` provides visible focus indicator
- ARIA label provides context for screen readers
- Conditional classes handle visual feedback automatically

### useTodos Hook toggleTodo Function
[Source: architecture/frontend-architecture.md, Story 1.3]

**Current Implementation (Story 1.3):**

```typescript
// lib/hooks/useTodos.ts
const toggleTodo = (id: string) => {
  const todo = todos.find((t) => t.id === id);
  if (todo) {
    updateTodo(id, { completed: !todo.completed });
  }
};
```

**Behind the Scenes (updateTodo function):**

```typescript
const updateTodo = (id: string, updates: UpdateTodoInput) => {
  const updatedTodos = todos.map((todo) => (todo.id === id ? { ...todo, ...updates } : todo));
  setTodos(updatedTodos); // Optimistic update

  try {
    todoStorage.saveTodos(updatedTodos); // Persist to localStorage
    setError(null);
  } catch (err) {
    setError(err instanceof StorageError ? err.message : 'Failed to update todo');
    setTodos(todos); // Rollback on error
  }
};
```

**Key Points:**
- Optimistic UI update (state changes before storage persists)
- Automatic localStorage synchronization
- Error handling with state rollback
- Follows React best practices (functional setState pattern)

### Testing Strategy for Toggle Functionality
[Source: architecture/testing-strategy.md]

**Component Test Pattern (TodoItem):**

```typescript
// __tests__/components/TodoItem.test.tsx
import { render, screen, fireEvent } from '@testing-library/react';
import { TodoItem } from '@/components/TodoItem';

describe('TodoItem - Toggle Functionality', () => {
  const mockTodo = {
    id: '1',
    text: 'Test todo',
    completed: false,
    createdAt: Date.now(),
  };

  it('should call onToggle when checkbox is clicked', () => {
    const mockToggle = jest.fn();
    render(<TodoItem todo={mockTodo} onToggle={mockToggle} onEdit={() => {}} onDelete={() => {}} />);
    
    const checkbox = screen.getByRole('checkbox');
    fireEvent.click(checkbox);
    
    expect(mockToggle).toHaveBeenCalledTimes(1);
  });

  it('should apply strikethrough when completed', () => {
    const completedTodo = { ...mockTodo, completed: true };
    render(<TodoItem todo={completedTodo} onToggle={() => {}} onEdit={() => {}} onDelete={() => {}} />);
    
    const text = screen.getByText(completedTodo.text);
    expect(text).toHaveClass('line-through');
    expect(text).toHaveClass('text-gray-500');
  });

  it('should not have strikethrough when incomplete', () => {
    render(<TodoItem todo={mockTodo} onToggle={() => {}} onEdit={() => {}} onDelete={() => {}} />);
    
    const text = screen.getByText(mockTodo.text);
    expect(text).not.toHaveClass('line-through');
    expect(text).toHaveClass('text-gray-900');
  });

  it('should toggle on Space key', () => {
    const mockToggle = jest.fn();
    render(<TodoItem todo={mockTodo} onToggle={mockToggle} onEdit={() => {}} onDelete={() => {}} />);
    
    const checkbox = screen.getByRole('checkbox');
    fireEvent.keyDown(checkbox, { key: ' ' });
    
    expect(mockToggle).toHaveBeenCalled();
  });

  it('should have descriptive ARIA label', () => {
    render(<TodoItem todo={mockTodo} onToggle={() => {}} onEdit={() => {}} onDelete={() => {}} />);
    
    const checkbox = screen.getByLabelText(/Mark "Test todo" as complete/i);
    expect(checkbox).toBeInTheDocument();
  });
});
```

**Hook Test Pattern (useTodos):**

```typescript
// __tests__/lib/hooks/useTodos.test.ts
import { renderHook, act } from '@testing-library/react';
import { useTodos } from '@/lib/hooks/useTodos';

describe('useTodos - toggleTodo', () => {
  it('should toggle todo completion', () => {
    const { result } = renderHook(() => useTodos());
    
    // Add a todo
    act(() => {
      result.current.addTodo('Task to toggle');
    });
    
    const todoId = result.current.todos[0].id;
    expect(result.current.todos[0].completed).toBe(false);
    
    // Toggle to complete
    act(() => {
      result.current.toggleTodo(todoId);
    });
    
    expect(result.current.todos[0].completed).toBe(true);
    
    // Toggle back to incomplete
    act(() => {
      result.current.toggleTodo(todoId);
    });
    
    expect(result.current.todos[0].completed).toBe(false);
  });

  it('should persist toggle to localStorage', () => {
    const { result } = renderHook(() => useTodos());
    
    act(() => {
      result.current.addTodo('Task to persist');
    });
    
    const todoId = result.current.todos[0].id;
    
    act(() => {
      result.current.toggleTodo(todoId);
    });
    
    // Verify saveTodos was called with updated todo
    const savedTodos = JSON.parse(localStorage.getItem('todos') || '[]');
    expect(savedTodos[0].completed).toBe(true);
  });
});
```

**Integration Test Pattern (TodoApp):**

```typescript
// __tests__/components/TodoApp.test.tsx
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import { TodoApp } from '@/components/TodoApp';

describe('TodoApp - Toggle Integration', () => {
  beforeEach(() => {
    localStorage.clear();
  });

  it('should toggle todo completion and persist', async () => {
    render(<TodoApp />);
    
    // Add a todo
    const input = screen.getByRole('textbox');
    const addButton = screen.getByRole('button', { name: /add/i });
    
    fireEvent.change(input, { target: { value: 'Test task' } });
    fireEvent.click(addButton);
    
    // Find checkbox
    const checkbox = screen.getByRole('checkbox');
    expect(checkbox).not.toBeChecked();
    
    // Toggle to complete
    fireEvent.click(checkbox);
    
    await waitFor(() => {
      expect(checkbox).toBeChecked();
    });
    
    // Verify visual feedback
    const todoText = screen.getByText('Test task');
    expect(todoText).toHaveClass('line-through');
    
    // Verify persistence
    const saved = JSON.parse(localStorage.getItem('todos') || '[]');
    expect(saved[0].completed).toBe(true);
  });
});
```

### Performance Considerations
[Source: architecture/security-and-performance.md, PRD NFR3]

**NFR3 Requirement:** All user interactions must provide visual feedback within 100ms.

**How This Is Achieved:**
1. **Optimistic Updates:** `setTodos(updatedTodos)` happens immediately, before localStorage
2. **React Rendering:** React's reconciliation updates only the changed todo item
3. **CSS Transitions:** Tailwind's `transition-colors` provides smooth visual changes
4. **No Network Calls:** All operations are client-side, eliminating latency

**Testing Performance:**
- Manual testing should verify checkbox response feels instant
- No perceptible delay between click and visual feedback
- Strikethrough and color change should appear immediately

### Accessibility Requirements
[Source: architecture/coding-standards.md, PRD NFR7]

**Keyboard Navigation:**
- ✅ Checkbox is natively keyboard accessible (Space/Enter keys)
- ✅ Tab key moves focus to checkbox
- ✅ Focus indicator visible (`focus:ring-2 focus:ring-blue-500`)

**Screen Reader Support:**
- ✅ ARIA label provides context: "Mark 'Task name' as complete/incomplete"
- ✅ Checkbox role is implicit in `<input type="checkbox">`
- ✅ Screen reader announces state changes when checkbox is toggled

**Testing Accessibility:**
- Manual test with keyboard only (no mouse)
- Verify focus indicator is clearly visible
- Test with screen reader (optional but recommended)

### Coding Standards
[Source: architecture/coding-standards.md]

**Critical Rules:**
- ✅ No changes to existing code needed (functionality already implemented)
- ✅ Tests must follow established patterns from Stories 1.2-1.3
- ✅ All tests must have descriptive names explaining what is being tested
- ✅ Mock dependencies appropriately (TodoItem mocks callbacks, useTodos tests use real storage)
- ✅ Verify test coverage remains above 80%

### Success Criteria Verification

Before marking this story as complete, verify:

1. ✅ Each todo has a checkbox reflecting completion status
2. ✅ Clicking checkbox toggles completed state immediately
3. ✅ Completed todos show strikethrough and muted color
4. ✅ Incomplete todos show normal text appearance
5. ✅ Toggle is persisted to localStorage instantly
6. ✅ Checkbox is keyboard accessible (Space/Enter keys work)
7. ✅ All component tests pass with >80% coverage
8. ✅ Integration tests verify end-to-end toggle flow
9. ✅ `npm run type-check` passes with no errors
10. ✅ `npm run lint` passes with no errors
11. ✅ Manual testing confirms smooth, instant visual feedback
12. ✅ Focus indicator visible when checkbox is focused
13. ✅ ARIA labels provide proper context

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-01 | 1.0 | Story created from Epic 1 | Bob (SM) |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_To be filled by QA Agent_
